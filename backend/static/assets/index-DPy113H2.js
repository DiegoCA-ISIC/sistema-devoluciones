(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const p of a.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&o(p)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}})();const c={devoluciones:[],currentDevolucion:null,loading:!1,error:null},s={get empresa(){return document.getElementById("empresa")},get monto(){return document.getElementById("monto")},get fechaPeriodo(){return document.getElementById("fechaPeriodo")},get fechaSolicitud(){return document.getElementById("fechaSolicitud")},get btnNuevaDevolucion(){return document.getElementById("btnNuevaDevolucion")},get resultado(){return document.getElementById("resultado")},get tablaDevoluciones(){return document.getElementById("tablaDevoluciones")},get panelRequerimientos(){return document.getElementById("panel-requerimientos")},get loadingSpinner(){return document.getElementById("loading-spinner")}},l={async get(e){const t=await fetch(e);if(!t.ok){const n=await t.json().catch(()=>({}));throw new Error(n.message||`HTTP error! status: ${t.status}`)}return t.json()},async post(e,t){const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok){const o=await n.json().catch(()=>({}));throw new Error(o.message||`HTTP error! status: ${n.status}`)}return n.json()}},i={formatDate(e){if(!e)return"-";const t={year:"numeric",month:"short",day:"numeric"};return new Date(e).toLocaleDateString("es-MX",t)},formatearMonto(e){return e==null?"$0.00":new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(e)},validarFecha(e){if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return!1;const n=new Date(e);return!isNaN(n.getTime())&&n.toISOString().slice(0,10)===e}};function D(){I(),g(),w()}function I(){s.btnNuevaDevolucion.addEventListener("click",C),document.addEventListener("click",e=>{if(e.target.closest('[data-action="gestionar"]')){const t=e.target.closest("button").dataset.id;y(t)}}),document.getElementById("cerrar-panel").addEventListener("click",()=>{document.getElementById("panel-requerimientos").classList.remove("show"),document.body.style.overflow="auto"}),document.getElementById("filtroEmpresa").addEventListener("change",h)}async function g(){u(!0);try{const e=await l.get("http://localhost:5000/api/devoluciones");q(e),h(),c.calendario&&c.calendario.updateEvents(e)}catch(e){d(e.message),console.error("Error:",e)}finally{u(!1)}}async function C(){if(!i.validarFecha(s.fechaSolicitud.value)){d("Por favor ingrese una fecha válida (YYYY-MM-DD)");return}if(!s.empresa.value||!s.monto.value||!s.fechaPeriodo.value){d("Todos los campos son obligatorios");return}u(!0);try{const e={fecha_solicitud:s.fechaSolicitud.value,empresa:s.empresa.value,monto:parseFloat(s.monto.value),fecha_periodo:s.fechaPeriodo.value};console.log("Registrando devolución:",e);const t=await l.post("http://localhost:5000/api/devoluciones",e);B(t.id),f(`Devolución registrada:
Fecha Límite: ${i.formatDate(t.fecha_limite)}`),s.panelRequerimientos.style.display="block",await g()}catch(e){d(e.message),console.error("Error:",e)}finally{u(!1)}}document.getElementById("filtroEmpresa").addEventListener("change",h);function h(){const e=document.getElementById("filtroEmpresa").value,t=e?c.devoluciones.filter(o=>o.empresa_id==e):c.devoluciones;document.createDocumentFragment();const n=document.createElement("tbody");t.forEach(o=>{const r=document.createElement("tr");r.innerHTML=`
            <td>${o.id}</td>
            <td>${i.formatDate(o.fecha_solicitud)}</td>
            <td>${i.formatDate(o.fecha_limite)}</td>
            <td class="text-end">${i.formatearMonto(o.monto)}</td>  <!-- Nueva celda -->
            <td>${o.req1_notificacion?i.formatDate(o.req1_notificacion):"-"}</td>
            <td>${o.req2_notificacion?i.formatDate(o.req2_notificacion):"-"}</td>
            <td class="${o.dias_restantes<10?"text-danger":""}">
                ${o.dias_restantes}
            </td>
            <td>
                <span class="badge ${o.estado.includes("pausado")?"bg-warning":o.estado==="vencido"?"bg-danger":"bg-success"}">
                    ${o.estado.replace("_"," ").toUpperCase()}
                </span>
            </td>
            <td>
                <button class="btn-sm" data-action="gestionar" data-id="${o.id}">
                    <i class="fas fa-edit"></i> Gestionar
                </button>
            </td>
        `,n.appendChild(r)}),s.tablaDevoluciones.innerHTML=`
        <thead>
            <tr>
                <th>ID</th>
                <th>Fecha Solicitud</th>
                <th>Fecha Límite</th>
                <th>Monto</th>
                <th>1er Requerimiento</th>
                <th>2do Requerimiento</th>
                <th>Días Restantes</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
    `,s.tablaDevoluciones.appendChild(n)}function u(e){c.loading=e,m()}function q(e){c.devoluciones=e,m()}function B(e){c.currentDevolucion=e,m()}function d(e){c.error=e,m()}function m(){const e=document.getElementById("loading-spinner");e&&(c.loading?e.style.display="block":e.style.display="none")}function E(e){Swal.fire({icon:"error",title:"Error",text:e,timer:3e3,showConfirmButton:!1}),c.error=e}function f(e){Swal.fire({icon:"success",title:"Éxito",text:e,timer:2e3,showConfirmButton:!1})}async function y(e){B(e),s.panelRequerimientos.classList.add("show"),document.body.style.overflow="hidden";try{const t=await l.get(`http://localhost:5000/api/devoluciones/${e}`);document.getElementById("detalle-id").textContent=t.id,document.getElementById("detalle-fecha").textContent=i.formatDate(t.fecha_solicitud),document.getElementById("req1-notif").textContent=i.formatDate(t.req1_notificacion),document.getElementById("req1-solv").textContent=i.formatDate(t.req1_respuesta),document.getElementById("req2-notif").textContent=i.formatDate(t.req2_notificacion),document.getElementById("req2-solv").textContent=i.formatDate(t.req2_respuesta),document.getElementById("detalle-dias-transcurridos").textContent=t.dias_transcurridos,document.getElementById("detalle-dias-restantes").textContent=t.dias_restantes,_(t.dias_transcurridos);const n=document.getElementById("detalle-estado");n.className="badge",t.estado_calculado.startsWith("pausado")?n.classList.add("bg-warning"):t.estado_calculado==="vencido"?n.classList.add("bg-danger"):n.classList.add("bg-success"),document.getElementById("btnReq1").onclick=()=>v(e,1),document.getElementById("btnReq2").onclick=()=>v(e,2),document.getElementById("btnSolv1").onclick=()=>b(e,1),document.getElementById("btnSolv2").onclick=()=>b(e,2)}catch(t){d(t.message)}document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("calendar");new FullCalendar.Calendar(t,{initialView:"dayGridMonth",locale:"es",events:"/api/devoluciones",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"}}).render()})}async function v(e,t){try{const n=`http://localhost:5000/api/devoluciones/${e}/requerimientos`,o={tipo:t},r=await l.post(n,o);f(`Requerimiento tipo ${t} registrado correctamente.`),await g(),y(e)}catch(n){d(`Error al registrar requerimiento: ${n.message}`)}}async function b(e,t){const n=t===1?"req1_respuesta":"req2_respuesta",o=L();try{if(!(await fetch(`http://localhost:5000/api/devoluciones/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({[n]:o})})).ok)throw new Error("No se pudo registrar la solvencia");f(`Solvencia del requerimiento ${t} registrada.`),y(e)}catch(r){d(r.message)}}function L(){const e=new Date;return e.setMinutes(e.getMinutes()-e.getTimezoneOffset()),e.toISOString().split("T")[0]}function _(e){const n=Math.min(e/40*100,100).toFixed(0),o=document.getElementById("barra-progreso"),r=document.getElementById("porcentaje-progreso");o.style.width=`${n}%`,r.textContent=`${n}% del plazo utilizado`,n<75?o.style.backgroundColor="#2ecc71":n<100?o.style.backgroundColor="#f39c12":o.style.backgroundColor="#e74c3c"}document.getElementById("btnRegistrarEmpresa").addEventListener("click",async()=>{const e=document.getElementById("nombreEmpresa").value.trim(),t=document.getElementById("rfcEmpresa").value.trim().toUpperCase();if(!e)return E("El nombre de la empresa y el RFC no pueden estar vacíos.");try{if(!(await fetch("http://localhost:5000/api/empresas",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nombre:e,rfc:t||null})})).ok)throw new Error("No se pudo registrar la empresa.");f("Empresa registrada correctamente."),document.getElementById("nombreEmpresa").value="",document.getElementById("rfcEmpresa").value="",await w()}catch(n){E(n.message)}});async function w(){try{const e=await l.get("http://localhost:5000/api/empresas"),t=document.getElementById("empresa");t.innerHTML='<option value="">Selecciona una empresa</option>';const n=document.getElementById("filtroEmpresa");n.innerHTML='<option value="">Todas</option>',e.forEach(o=>{const r=document.createElement("option");r.value=o.id,r.textContent=o.nombre,t.appendChild(r);const a=document.createElement("option");a.value=o.id,a.textContent=o.nombre,n.appendChild(a)})}catch(e){console.error("Error al cargar empresas:",e.message)}}document.addEventListener("DOMContentLoaded",async()=>{D()});
