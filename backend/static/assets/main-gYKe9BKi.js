const i={devoluciones:[],currentDevolucion:null,loading:!1,error:null},d="https://sistema-devoluciones.onrender.com/api",a={get empresa(){return document.getElementById("empresa")},get monto(){return document.getElementById("monto")},get fechaPeriodo(){return document.getElementById("fechaPeriodo")},get fechaSolicitud(){return document.getElementById("fechaSolicitud")},get btnNuevaDevolucion(){return document.getElementById("btnNuevaDevolucion")},get resultado(){return document.getElementById("resultado")},get tablaDevoluciones(){return document.getElementById("tablaDevoluciones")},get panelRequerimientos(){return document.getElementById("panel-requerimientos")},get loadingSpinner(){return document.getElementById("loading-spinner")}},l={async get(e){const t=await fetch(e);if(!t.ok){const n=await t.json().catch(()=>({}));throw new Error(n.message||`HTTP error! status: ${t.status}`)}return t.json()},async post(e,t){const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok){const o=await n.json().catch(()=>({}));throw new Error(o.message||`HTTP error! status: ${n.status}`)}return n.json()}},s={formatDate(e){if(!e)return"-";const t={year:"numeric",month:"short",day:"numeric"};return new Date(e).toLocaleDateString("es-MX",t)},formatearMonto(e){return e==null?"$0.00":new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(e)},validarFecha(e){if(!/^\d{4}-\d{2}-\d{2}$/.test(e))return!1;const n=new Date(e);return!isNaN(n.getTime())&&n.toISOString().slice(0,10)===e}};function I(){w(),p(),D()}function w(){a.btnNuevaDevolucion.addEventListener("click",C),document.addEventListener("click",e=>{if(e.target.closest('[data-action="gestionar"]')){const t=e.target.closest("button").dataset.id;h(t)}}),document.getElementById("cerrar-panel").addEventListener("click",()=>{document.getElementById("panel-requerimientos").classList.remove("show"),document.body.style.overflow="auto"}),document.getElementById("filtroEmpresa").addEventListener("change",y)}async function p(){u(!0);try{const e=await l.get(`${d}/devoluciones`);$(e),y(),i.calendario&&i.calendario.updateEvents(e)}catch(e){c(e.message),console.error("Error:",e)}finally{u(!1)}}async function C(){if(!s.validarFecha(a.fechaSolicitud.value)){c("Por favor ingrese una fecha válida (YYYY-MM-DD)");return}if(!a.empresa.value||!a.monto.value||!a.fechaPeriodo.value){c("Todos los campos son obligatorios");return}u(!0);try{const e={fecha_solicitud:a.fechaSolicitud.value,empresa:a.empresa.value,monto:parseFloat(a.monto.value),fecha_periodo:a.fechaPeriodo.value};console.log("Registrando devolución:",e);const t=await l.post(`${d}/devoluciones`,e);B(t.id),g(`Devolución registrada:
Fecha Límite: ${s.formatDate(t.fecha_limite)}`),a.panelRequerimientos.style.display="block",await p()}catch(e){c(e.message),console.error("Error:",e)}finally{u(!1)}}document.getElementById("filtroEmpresa").addEventListener("change",y);function y(){const e=document.getElementById("filtroEmpresa").value,t=e?i.devoluciones.filter(o=>o.empresa_id==e):i.devoluciones;document.createDocumentFragment();const n=document.createElement("tbody");t.forEach(o=>{const r=document.createElement("tr");r.innerHTML=`
            <td>${o.id}</td>
            <td>${s.formatDate(o.fecha_solicitud)}</td>
            <td>${s.formatDate(o.fecha_limite)}</td>
            <td class="text-end">${s.formatearMonto(o.monto)}</td>  <!-- Nueva celda -->
            <td>${o.req1_notificacion?s.formatDate(o.req1_notificacion):"-"}</td>
            <td>${o.req2_notificacion?s.formatDate(o.req2_notificacion):"-"}</td>
            <td class="${o.dias_restantes<10?"text-danger":""}">
                ${o.dias_restantes}
            </td>
            <td>
                <span class="badge ${o.estado.includes("pausado")?"bg-warning":o.estado==="vencido"?"bg-danger":"bg-success"}">
                    ${o.estado.replace("_"," ").toUpperCase()}
                </span>
            </td>
            <td>
                <button class="btn-sm" data-action="gestionar" data-id="${o.id}">
                    <i class="fas fa-edit"></i> Gestionar
                </button>
            </td>
        `,n.appendChild(r)}),a.tablaDevoluciones.innerHTML=`
        <thead>
            <tr>
                <th>ID</th>
                <th>Fecha Solicitud</th>
                <th>Fecha Límite</th>
                <th>Monto</th>
                <th>1er Requerimiento</th>
                <th>2do Requerimiento</th>
                <th>Días Restantes</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
    `,a.tablaDevoluciones.appendChild(n)}function u(e){i.loading=e,m()}function $(e){i.devoluciones=e,m()}function B(e){i.currentDevolucion=e,m()}function c(e){i.error=e,m()}function m(){const e=document.getElementById("loading-spinner");e&&(i.loading?e.style.display="block":e.style.display="none")}function E(e){Swal.fire({icon:"error",title:"Error",text:e,timer:3e3,showConfirmButton:!1}),i.error=e}function g(e){Swal.fire({icon:"success",title:"Éxito",text:e,timer:2e3,showConfirmButton:!1})}async function h(e){B(e),a.panelRequerimientos.classList.add("show"),document.body.style.overflow="hidden";try{const t=await l.get(`${d}/devoluciones/${e}`);document.getElementById("detalle-id").textContent=t.id,document.getElementById("detalle-fecha").textContent=s.formatDate(t.fecha_solicitud),document.getElementById("req1-notif").textContent=s.formatDate(t.req1_notificacion),document.getElementById("req1-solv").textContent=s.formatDate(t.req1_respuesta),document.getElementById("req2-notif").textContent=s.formatDate(t.req2_notificacion),document.getElementById("req2-solv").textContent=s.formatDate(t.req2_respuesta),document.getElementById("detalle-dias-transcurridos").textContent=t.dias_transcurridos,document.getElementById("detalle-dias-restantes").textContent=t.dias_restantes,L(t.dias_transcurridos);const n=document.getElementById("detalle-estado");n.className="badge",t.estado_calculado.startsWith("pausado")?n.classList.add("bg-warning"):t.estado_calculado==="vencido"?n.classList.add("bg-danger"):n.classList.add("bg-success"),document.getElementById("btnReq1").onclick=()=>v(e,1),document.getElementById("btnReq2").onclick=()=>v(e,2),document.getElementById("btnSolv1").onclick=()=>b(e,1),document.getElementById("btnSolv2").onclick=()=>b(e,2)}catch(t){c(t.message)}document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("calendar");new FullCalendar.Calendar(t,{initialView:"dayGridMonth",locale:"es",events:"/api/devoluciones",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"}}).render()})}async function v(e,t){try{const n=`${d}/devoluciones/${e}/requerimientos`,o={tipo:t},r=await l.post(n,o);g(`Requerimiento tipo ${t} registrado correctamente.`),await p(),h(e)}catch(n){c(`Error al registrar requerimiento: ${n.message}`)}}async function b(e,t){const n=t===1?"req1_respuesta":"req2_respuesta",o=q();try{if(!(await fetch(`${d}/devoluciones/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({[n]:o})})).ok)throw new Error("No se pudo registrar la solvencia");g(`Solvencia del requerimiento ${t} registrada.`),h(e)}catch(r){c(r.message)}}function q(){const e=new Date;return e.setMinutes(e.getMinutes()-e.getTimezoneOffset()),e.toISOString().split("T")[0]}function L(e){const n=Math.min(e/40*100,100).toFixed(0),o=document.getElementById("barra-progreso"),r=document.getElementById("porcentaje-progreso");o.style.width=`${n}%`,r.textContent=`${n}% del plazo utilizado`,n<75?o.style.backgroundColor="#2ecc71":n<100?o.style.backgroundColor="#f39c12":o.style.backgroundColor="#e74c3c"}document.getElementById("btnRegistrarEmpresa").addEventListener("click",async()=>{const e=document.getElementById("nombreEmpresa").value.trim(),t=document.getElementById("rfcEmpresa").value.trim().toUpperCase();if(!e)return E("El nombre de la empresa y el RFC no pueden estar vacíos.");try{if(!(await fetch(`${d}/empresas`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nombre:e,rfc:t||null})})).ok)throw new Error("No se pudo registrar la empresa.");g("Empresa registrada correctamente."),document.getElementById("nombreEmpresa").value="",document.getElementById("rfcEmpresa").value="",await D()}catch(n){E(n.message)}});async function D(){try{const e=await l.get(`${d}/empresas`),t=document.getElementById("empresa");t.innerHTML='<option value="">Selecciona una empresa</option>';const n=document.getElementById("filtroEmpresa");n.innerHTML='<option value="">Todas</option>',e.forEach(o=>{const r=document.createElement("option");r.value=o.id,r.textContent=o.nombre,t.appendChild(r);const f=document.createElement("option");f.value=o.id,f.textContent=o.nombre,n.appendChild(f)})}catch(e){console.error("Error al cargar empresas:",e.message)}}document.addEventListener("DOMContentLoaded",async()=>{I()});
